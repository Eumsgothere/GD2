using UnityEngine;
using UnityEngine.InputSystem;

public class Player_script : MonoBehaviour
{
    public Transform respawnPoint;
    public float fallLimit = -10f;

    [Header("Input Settings")]
    [SerializeField] private InputActionAsset inputAction;

    [Header("References")]
    [SerializeField] private CharacterController characterController;
    [SerializeField] private GameObject blueBallPrefab;
    [SerializeField] private GameObject redBallPrefab;
    [SerializeField] private Transform shootPoint;

    [Header("Player Movement")]
    [SerializeField] private float moveSpeed = 10f;
    [SerializeField] private float jumpForce = 30f;
    [SerializeField] private float gravity = -9.81f;
    [SerializeField] private float shootForce = 20f;

    private InputAction moveAction;
    private InputAction lookAction;
    private InputAction jumpAction;
    private InputAction shootAction;
    private InputAction switchBallAction;

    private float verticalVelocity;
    private Vector3 spawnPoint;

    private enum BallType { Blue, Red }
    private BallType currentBallType = BallType.Blue;

    // Orbiting balls
    private GameObject blueBallOrbit;
    private GameObject redBallOrbit;
    [SerializeField] private float orbitRadius = 1.5f;
    [SerializeField] private float orbitSpeed = 80f;

    private bool isSwitch = false;
    private float switchTimer = 0f;
    private float switchDuration = 1.5f;

    private void Start()
    {
        var playerMap = inputAction.FindActionMap("Player");
        moveAction = playerMap.FindAction("Move");
        lookAction = playerMap.FindAction("Look");
        jumpAction = playerMap.FindAction("Jump");
        shootAction = playerMap.FindAction("Shoot");
        switchBallAction = playerMap.FindAction("SwitchBall");

        jumpAction.performed += Jump_performed;
        shootAction.performed += Shoot_performed;
        switchBallAction.performed += SwitchBall_performed;

        characterController = GetComponent<CharacterController>();
        spawnPoint = transform.position;

        // Create orbiting balls once and keep them
        blueBallOrbit = CreateBall(blueBallPrefab, transform.position + Vector3.right * orbitRadius);
        redBallOrbit = CreateBall(redBallPrefab, transform.position + Vector3.left * orbitRadius);

        SetBallKinematic(blueBallOrbit, true);
        SetBallKinematic(redBallOrbit, true);
    }

    private GameObject CreateBall(GameObject prefab, Vector3 position)
    {
        GameObject ball = Object.Instantiate(prefab, position, Quaternion.identity);
        return ball;
    }

    private void SetBallKinematic(GameObject ball, bool state)
    {
        if (ball.TryGetComponent(out Rigidbody rb))
            rb.isKinematic = state;
    }

    private void OnEnable() => inputAction.FindActionMap("Player").Enable();
    private void OnDisable() => inputAction.FindActionMap("Player").Disable();

    private void Respawn()
    {
        if (respawnPoint != null)
        {
            transform.position = respawnPoint.position;
            transform.rotation = respawnPoint.rotation;

            if (TryGetComponent(out Rigidbody rb))
            {
                rb.linearVelocity = Vector3.zero;
                rb.angularVelocity = Vector3.zero;
            }
        }
        else
        {
            Debug.LogWarning("No respawn point assigned to Player_script!");
        }
    }

    private void Jump_performed(InputAction.CallbackContext obj)
    {
        if (characterController.isGrounded)
            verticalVelocity = jumpForce;
    }

    private void SwitchBall_performed(InputAction.CallbackContext obj)
    {
        currentBallType = (currentBallType == BallType.Blue) ? BallType.Red : BallType.Blue;
        Debug.Log("Switched to " + currentBallType + " ball!");
        isSwitch = true;
        switchTimer = 0f;
    }

    private void Shoot_performed(InputAction.CallbackContext obj)
    {
        // Choose prefab (not orbiting ball)
        GameObject prefabToShoot = (currentBallType == BallType.Blue) ? blueBallPrefab : redBallPrefab;

        // Create thrown ball
        GameObject thrownBall = Object.Instantiate(prefabToShoot, shootPoint.position, shootPoint.rotation);

        // Apply shooting logic
        if (thrownBall.TryGetComponent(out BallScript ballScript))
        {
            ballScript.Shoot(shootPoint.forward, shootForce);
        }
        else
        {
            Debug.LogWarning("Thrown ball is missing BallScript!");
        }

        // Destroy ball after 5 seconds
        Object.Destroy(thrownBall, 3f);

        
    }

    private void FixedUpdate()
    {
        // Movement
        Vector2 move = moveAction.ReadValue<Vector2>();
        Vector3 moveDir = transform.TransformDirection(new Vector3(move.x, 0, move.y)) * moveSpeed;

        if (characterController.isGrounded && verticalVelocity < 0)
            verticalVelocity = -2f;

        verticalVelocity += gravity * Time.fixedDeltaTime;
        moveDir.y = verticalVelocity;

        characterController.Move(moveDir * Time.fixedDeltaTime);

        float rotation = lookAction.ReadValue<Vector2>().x;
        transform.Rotate(0, rotation, 0);


        if (isSwitch)
        {
            switchTimer += Time.fixedDeltaTime;

            if (blueBallOrbit != null)
                blueBallOrbit.transform.RotateAround(transform.position, Vector3.up, orbitSpeed * Time.fixedDeltaTime);
            if (redBallOrbit != null)
                redBallOrbit.transform.RotateAround(transform.position, Vector3.up, orbitSpeed * Time.fixedDeltaTime);

            if (switchTimer >= switchDuration)
                isSwitch = false;
        }
    }
}
