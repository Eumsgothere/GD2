using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.UI;
using UnityEngine.EventSystems;

public class PlayerSc : MonoBehaviour
{
    [Header("Components")]
    [SerializeField] private CharacterController charController;
    [SerializeField] private InputActionAsset inputAction;
    [SerializeField] private Animator animator;

    [Header("Movement Settings")]
    [SerializeField] private float walkSpeed = 5f;
    [SerializeField] private float sprintSpeed = 8f;
    [SerializeField] private float jumpHeight = 2f;
    [SerializeField] private float gravity = 9.8f;
    [SerializeField] private Transform respawnPoint;

    private InputAction move, look, sprint, jump, melee;
    private Vector2 moveInput, lookInput;
    private Vector3 velocity;
    private bool isSprinting;
    private bool hasWon = false;
    private bool isJumping = false;

    [Header("Combat")]
    public Collider handHitbox;

    private string playerName = "";
    private bool gameStarted = false;
    private float gameTimer = 0f;
    private bool gameOver = false;
    private bool canMove = false;


    private bool isGrounded => charController.isGrounded;
    public int life = 5;


    private void OnEnable()
    {
        var map = inputAction.FindActionMap("Player");
        map.Enable();

        move = map.FindAction("Move");
        look = map.FindAction("Look");
        sprint = map.FindAction("Sprint");
        jump = map.FindAction("Jump");
        melee = map.FindAction("Meele");

        sprint.performed += ctx => { if (!hasWon) isSprinting = true; };
        sprint.canceled += ctx => { if (!hasWon) isSprinting = false; };
        jump.performed += JumpInput;
        melee.performed += MeleeAttack;
    }

    private void Update()
    {
        if (!gameStarted) return;



        if (gameStarted && !gameOver && !hasWon)
        {
            gameTimer += Time.deltaTime;
        }

        if (!hasWon)
        {
            HandleMovement();
            HandleRotation();

            if (transform.position.y < -10f)
                Respawn();
        }
    }
    private void OnGUI()
    {
        GUIStyle title = new GUIStyle(GUI.skin.label);
        title.fontSize = 28;
        title.fontStyle = FontStyle.Bold;
        title.normal.textColor = Color.white;

        GUIStyle label = new GUIStyle(GUI.skin.label);
        label.fontSize = 18;
        label.normal.textColor = Color.white;

        if (!gameStarted && !gameOver && !hasWon)
        {
            GUI.Box(new Rect(Screen.width / 2 - 150, Screen.height / 2 - 120, 300, 220), "Enter Player Name");

            GUI.Label(new Rect(Screen.width / 2 - 120, Screen.height / 2 - 70, 250, 30), "Player Name:", label);
            playerName = GUI.TextField(new Rect(Screen.width / 2 - 120, Screen.height / 2 - 40, 240, 30), playerName);

            if (GUI.Button(new Rect(Screen.width / 2 - 60, Screen.height / 2 + 20, 120, 40), "START"))
            {
                if (playerName.Trim() != "")
                {
                    gameStarted = true;
                    canMove = true;    
                }
            }

            return;
        }

        if (gameStarted && !hasWon && !gameOver)
        {
            GUI.Label(new Rect(40, 30, 200, 40), $"Life: {life}", label);
            GUI.Label(new Rect(40, 70, 300, 40), $"Time: {gameTimer:F0}", label);
            GUI.Box(new Rect(20, 20, 200, 100), "");
        }

 
        if (hasWon)
        {
            GUI.Box(new Rect(Screen.width / 2 - 250, Screen.height / 2 - 120, 500, 200), "");
            GUI.Label(new Rect(Screen.width / 2 - 200, Screen.height / 2 - 80, 350, 40),
                $"Congratulations, {playerName}!", title);

            GUI.Label(new Rect(Screen.width / 2 - 90, Screen.height / 2 - 30, 350, 40),
                $"Your Time: {gameTimer:F0} seconds", label);
        }

        if (gameOver)
        {
            GUI.Box(new Rect(Screen.width / 2 - 150, Screen.height / 2 - 80, 300, 160), "");
            GUI.Label(new Rect(Screen.width / 2 - 105, Screen.height / 2 - 40, 300, 40),
                "GAME OVER!!", title);
            GUI.Label(new Rect(Screen.width / 2 - 85, Screen.height / 2 , 300, 40),
                "YOU LOSE!", title);
        }
    }
    private void HandleMovement()
    {
        if (!canMove) return;
        moveInput = move.ReadValue<Vector2>();
        float currentSpeed = isSprinting ? sprintSpeed : walkSpeed;
        Vector3 moveDir = transform.TransformDirection(new Vector3(moveInput.x, 0, moveInput.y)) * currentSpeed;

        if (isGrounded && velocity.y <= 0)
        {
            velocity.y = -1f;
            animator.SetBool("Fall", false);

            if (isJumping)
                isJumping = false;
        }
        else
        {
            velocity.y -= gravity * Time.deltaTime;
            if (velocity.y < -0.01f)
                animator.SetBool("Fall", true);
        }

        charController.Move((moveDir + velocity) * Time.deltaTime);


        float forward = moveInput.y;
        float walkAmount = Mathf.Abs(moveInput.y);
        animator.SetFloat("Walk", walkAmount);
        animator.SetFloat("Forward", forward);
        animator.SetBool("Run", isSprinting && forward > 0.1f);
    }

    private void JumpInput(InputAction.CallbackContext context)
    {
        if (!gameStarted || !canMove) return;
        if (hasWon || isJumping || !isGrounded) return;

        isJumping = true;
        velocity.y = Mathf.Sqrt(jumpHeight * 2f * gravity);

        animator.ResetTrigger("Meele");
        animator.SetTrigger("Jump");
        animator.SetBool("Fall", false);
    }

    private void MeleeAttack(InputAction.CallbackContext context)
    {
        if (!gameStarted || !canMove) return;   
        if (hasWon || isJumping) return;

        animator.ResetTrigger("Jump");
        animator.ResetTrigger("Meele");
        animator.SetTrigger("Meele");
    }

    private void HandleRotation()
    {
        if (gameOver || hasWon || !gameStarted) return;

        lookInput = look.ReadValue<Vector2>();
        transform.Rotate(0f, lookInput.x, 0f);
    }

    private void Respawn()
    {
        velocity = Vector3.zero;
        charController.enabled = false;
        transform.position = respawnPoint.position;
        charController.enabled = true;
    }
    public void TakeDamage(int amount)
    {
        if (!canMove) return;

        life -= amount;
        Respawn();
        if (life <= 0)
        {
            life = 0;
            canMove = false;
            gameOver = true;
            charController.enabled = false;
            animator.SetFloat("Walk", 0);
            animator.SetBool("Run", false);
            animator.SetBool("Fall", false);

            animator.ResetTrigger("Jump");
            animator.ResetTrigger("Meele");
            animator.SetTrigger("Lost");
        }
    }
    public void Win()
    {
        hasWon = true;
        canMove = false;

        charController.enabled = false;

        animator.SetFloat("Walk", 0);
        animator.SetBool("Run", false);
        animator.SetBool("Fall", false);

        animator.ResetTrigger("Jump");
        animator.ResetTrigger("Meele");
        animator.SetTrigger("Win");
    }
}
